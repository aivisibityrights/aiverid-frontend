<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Your AIVerID™ - Universal AI Rights & Digital Identity</title>
  
  <style>
    /* ============================================
       GLOBAL STYLES & CSS VARIABLES
    ============================================ */
    :root {
      --primary: #00d4ff;
      --primary-dark: #0099cc;
      --secondary: #6366f1;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --dark-bg: #0f172a;
      --dark-surface: #1e293b;
      --dark-border: rgba(148,163,184,0.2);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --gradient-1: linear-gradient(135deg, #00d4ff 0%, #6366f1 100%);
      --gradient-2: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      --glow: 0 0 40px rgba(0,212,255,0.3), 0 0 80px rgba(99,102,241,0.2);
      --shadow-lg: 0 20px 40px rgba(0,0,0,0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      line-height: 1.6;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(0,212,255,0.2) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(99,102,241,0.2) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(0,212,255,0.1) 0%, transparent 70%);
      animation: bgPulse 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 0.8; transform: scale(1) rotate(0deg); }
      50% { opacity: 1; transform: scale(1.1) rotate(5deg); }
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 40px 0;
      position: relative;
    }

    .logo {
      font-size: 3rem;
      font-weight: 900;
      background: var(--gradient-1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
      display: inline-block;
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }

    .tagline {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    /* Mode Switcher */
    .mode-switcher {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 40px;
    }

    .mode-btn {
      padding: 12px 24px;
      border: 2px solid var(--dark-border);
      background: var(--dark-surface);
      color: var(--text-secondary);
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .mode-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: var(--gradient-1);
      transform: translate(-50%, -50%);
      border-radius: 50%;
      transition: all 0.3s ease;
      z-index: 0;
    }

    .mode-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,212,255,0.2);
    }

    .mode-btn.active {
      background: var(--gradient-1);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 0 20px rgba(0,212,255,0.3);
    }

    .mode-btn span {
      position: relative;
      z-index: 1;
    }

    /* Register Container */
    .register-container {
      background: var(--gradient-2);
      border-radius: 20px;
      padding: 40px;
      box-shadow: var(--shadow-lg), var(--glow);
      border: 1px solid var(--dark-border);
      position: relative;
      overflow: hidden;
    }

    .register-container::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0,212,255,0.1) 0%, transparent 70%);
      animation: rotate 30s linear infinite;
      pointer-events: none;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
      z-index: 1;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step-number {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--dark-surface);
      border: 3px solid var(--dark-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: 700;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
    }

    .step.active .step-number {
      background: var(--gradient-1);
      border-color: var(--primary);
      color: white;
      box-shadow: 0 0 20px rgba(0,212,255,0.5);
      animation: stepPulse 2s ease-in-out infinite;
    }

    @keyframes stepPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .step.completed .step-number {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .step-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .step.active .step-title {
      color: var(--primary);
    }

    /* Progress Line */
    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 25px;
      left: 50%;
      width: 100%;
      height: 3px;
      background: var(--dark-border);
      z-index: 1;
    }

    .step.completed:not(:last-child)::after {
      background: var(--success);
    }

    /* Form Sections */
    .step-section {
      display: none;
      animation: fadeIn 0.5s ease;
      position: relative;
      z-index: 1;
    }

    .step-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Section Indicator */
    .section-indicator {
      display: none;
      gap: 10px;
      margin-bottom: 30px;
    }

    .section-indicator.show {
      display: flex;
    }

    .section-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--dark-border);
      transition: all 0.3s ease;
    }

    .section-dot.active {
      background: var(--primary);
      box-shadow: 0 0 10px rgba(0,212,255,0.5);
    }

    .section-dot.completed {
      background: var(--success);
    }

    /* Account Type Cards */
    .account-types {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .type-card {
      padding: 25px;
      border: 2px solid var(--dark-border);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      background: rgba(255,255,255,0.03);
      position: relative;
      overflow: hidden;
    }

    .type-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gradient-1);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 0;
    }

    .type-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,212,255,0.2);
      border-color: var(--primary);
    }

    .type-card.selected {
      border-color: var(--primary);
      background: rgba(0,212,255,0.1);
      box-shadow: 0 0 0 4px rgba(0,212,255,0.2);
    }

    .type-card.selected::before {
      opacity: 0.1;
    }

    .type-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .type-title {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
      font-size: 1.1rem;
      position: relative;
      z-index: 1;
    }

    .type-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.4;
      position: relative;
      z-index: 1;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 24px;
    }

    .form-group.hidden {
      display: none;
    }

    label {
      font-size: 0.95rem;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }

    .required {
      color: var(--error);
    }

    .input-wrapper {
      position: relative;
    }

    input, select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--dark-border);
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      backdrop-filter: blur(10px);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(0,212,255,0.1);
      box-shadow: 
        0 0 0 4px rgba(0,212,255,0.1),
        0 4px 20px rgba(0,212,255,0.2);
    }

    input.error, select.error {
      border-color: var(--error);
      background: rgba(239,68,68,0.1);
      box-shadow: 0 0 0 4px rgba(239,68,68,0.1);
    }

    input.success, select.success {
      border-color: var(--success);
      background: rgba(16,185,129,0.1);
      box-shadow: 0 0 0 4px rgba(16,185,129,0.1);
    }

    /* Password Strength */
    .password-strength {
      margin-top: 8px;
    }

    .strength-bar {
      height: 5px;
      background: var(--dark-border);
      border-radius: 3px;
      overflow: hidden;
    }

    .strength-fill {
      height: 100%;
      transition: all 0.3s ease;
      border-radius: 3px;
    }

    .strength-text {
      font-size: 0.85rem;
      margin-top: 5px;
      color: var(--text-secondary);
    }

    /* Phone Input */
    .phone-input-wrapper {
      display: flex;
      gap: 10px;
    }

    .country-code {
      background: rgba(0,212,255,0.1);
      color: var(--primary);
      border: 2px solid rgba(0,212,255,0.2);
      border-radius: 12px;
      padding: 14px 16px;
      font-weight: 600;
      font-size: 15px;
      min-width: 90px;
      text-align: center;
    }

    .phone-number {
      flex: 1;
    }

    /* Organization Fields */
    .org-fields {
      margin-top: 20px;
      padding: 20px;
      background: rgba(0,212,255,0.05);
      border-radius: 15px;
      border: 1px solid rgba(0,212,255,0.2);
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.5s ease;
    }

    .org-fields.show {
      max-height: 500px;
      opacity: 1;
      margin-bottom: 20px;
    }

    /* Checkbox Group */
    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 20px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-top: 4px;
      cursor: pointer;
    }

    .checkbox-group label {
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0;
    }

    /* Action Buttons */
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      padding: 16px 32px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: var(--gradient-1);
      color: white;
      box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,212,255,0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--dark-surface);
      color: var(--text-primary);
      border: 2px solid var(--dark-border);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: none;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    .loading-spinner.show {
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Messages */
    .error-message, .success-message {
      font-size: 0.85rem;
      margin-top: 8px;
      display: none;
      padding: 8px 12px;
      border-radius: 8px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .error-message {
      color: white;
      background: rgba(239,68,68,0.9);
      border: 1px solid var(--error);
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      color: white;
      background: rgba(16,185,129,0.9);
      border: 1px solid var(--success);
    }

    .success-message.show {
      display: block;
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Global Alert */
    .global-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      z-index: 9999;
      display: none;
      animation: slideInRight 0.5s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .global-alert.error {
      background: var(--error);
    }

    .global-alert.success {
      background: var(--success);
    }

    .global-alert.show {
      display: block;
    }

    /* API Status */
    .api-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      z-index: 100;
    }

    .api-status::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .api-status.checking {
      background: rgba(251,191,36,0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .api-status.connected {
      background: rgba(16,185,129,0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .api-status.disconnected {
      background: rgba(239,68,68,0.2);
      color: var(--error);
      border: 1px solid var(--error);
    }

    /* Auto Save Indicator */
    .auto-save {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      background: rgba(16,185,129,0.9);
      color: white;
      border-radius: 20px;
      font-size: 0.85rem;
      display: none;
      animation: fadeInOut 2s ease;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    .auto-save.show {
      display: block;
    }

    /* Back Link */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .back-link:hover {
      color: var(--primary);
      transform: translateX(-5px);
    }

    /* Footer */
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
      margin: 0 10px;
      transition: opacity 0.3s ease;
    }

    .footer a:hover {
      opacity: 0.8;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .register-container {
        padding: 25px 20px;
      }

      .header {
        padding: 20px 0;
      }

      .logo {
        font-size: 2.2rem;
      }

      .progress-steps {
        gap: 10px;
      }

      .step-number {
        width: 40px;
        height: 40px;
        font-size: 0.9rem;
      }

      .step-title {
        font-size: 0.8rem;
      }

      .account-types {
        grid-template-columns: 1fr;
      }

      .form-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .api-status {
        bottom: 10px;
        right: 10px;
        font-size: 0.8rem;
      }
    }

    /* Dark scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--dark-surface);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--dark-border);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
  </style>
</head>
<body>
  <!-- Auto Save Indicator -->
  <div class="auto-save" id="autoSave">✓ Auto-saved</div>

  <!-- Global Alert -->
  <div class="global-alert" id="globalAlert"></div>

  <!-- API Status -->
  <div class="api-status checking" id="apiStatus">
    <span id="apiStatusText">Checking API...</span>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <a href="/" class="back-link">← Back to Home</a>
      <h1 class="logo">AIVerID™</h1>
      <p class="tagline">Your Universal AI Rights & Digital Identity</p>
    </div>

    <!-- Mode Switcher -->
    <div class="mode-switcher">
      <button class="mode-btn active" data-mode="simple">
        <span>🚀 Simple Mode</span>
      </button>
      <button class="mode-btn" data-mode="steps">
        <span>📋 Step by Step</span>
      </button>
    </div>

    <!-- Registration Form -->
    <div class="register-container">
      <!-- Progress Steps (Hidden by default) -->
      <div class="progress-steps hidden" id="progressSteps">
        <div class="step active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-title">Account Type</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-title">Basic Info</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-title">Security</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-title">AI Rights</div>
        </div>
      </div>

      <!-- Section Indicator (Simple Mode) -->
      <div class="section-indicator" id="sectionIndicator">
        <div class="section-dot active" data-section="type"></div>
        <div class="section-dot" data-section="info"></div>
        <div class="section-dot" data-section="security"></div>
        <div class="section-dot" data-section="rights"></div>
      </div>

      <form id="registerForm" novalidate>
        <!-- Step 1: Account Type -->
        <div class="step-section active" data-step="1">
          <h2 style="margin-bottom: 20px; color: var(--primary);">Choose Your Account Type</h2>
          
          <div class="account-types">
            <div class="type-card" data-type="individual">
              <div class="type-icon">👤</div>
              <div class="type-title">Individual</div>
              <div class="type-desc">Personal AI Rights & Identity</div>
            </div>
            <div class="type-card" data-type="organization">
              <div class="type-icon">🏢</div>
              <div class="type-title">Organization</div>
              <div class="type-desc">Company AI Rights Management</div>
            </div>
          </div>

          <input type="hidden" id="accountType" name="accountType" required>
          <div class="error-message" id="errAccountType">Please select an account type</div>

          <!-- Organization Fields -->
          <div class="org-fields" id="orgFields">
            <div class="form-group">
              <label for="companyName">Company Name <span class="required">*</span></label>
              <div class="input-wrapper">
                <input type="text" id="companyName" name="companyName" placeholder="Your Company Ltd.">
              </div>
              <div class="error-message" id="errCompanyName"></div>
            </div>

            <div class="form-group">
              <label for="adminName">Admin Name <span class="required">*</span></label>
              <div class="input-wrapper">
                <input type="text" id="adminName" name="adminName" placeholder="John Doe">
              </div>
              <div class="error-message" id="errAdminName"></div>
            </div>

            <div class="form-group">
              <label for="registrationNumber">Registration Number</label>
              <div class="input-wrapper">
                <input type="text" id="registrationNumber" name="registrationNumber" placeholder="1234567890">
              </div>
              <div class="help-text">Company registration or tax ID</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Basic Information -->
        <div class="step-section" data-step="2">
          <h2 style="margin-bottom: 20px; color: var(--primary);">Basic Information</h2>

          <div class="form-group">
            <label for="firstName">First Name <span class="required">*</span></label>
            <div class="input-wrapper">
              <input type="text" id="firstName" name="firstName" placeholder="นันทวัฒน์" maxlength="50" required>
            </div>
            <div class="error-message" id="errFirstName"></div>
            <div class="success-message" id="successFirstName"></div>
          </div>

          <div class="form-group">
            <label for="lastName">Last Name <span class="required">*</span></label>
            <div class="input-wrapper">
              <input type="text" id="lastName" name="lastName" placeholder="ใจดี" maxlength="50" required>
            </div>
            <div class="help-text">For single names (mononym), use "-" in the unused field</div>
            <div class="error-message" id="errLastName"></div>
            <div class="success-message" id="successLastName"></div>
          </div>

          <div class="form-group">
            <label for="email">Email Address <span class="required">*</span></label>
            <div class="input-wrapper">
              <input type="email" id="email" name="email" placeholder="your.name@example.com" maxlength="100" required>
            </div>
            <div class="error-message" id="errEmail"></div>
            <div class="success-message" id="successEmail"></div>
          </div>

          <div class="form-group">
            <label for="phone">Phone Number <span class="required">*</span></label>
            <div class="phone-input-wrapper">
              <div class="country-code" id="countryCode">+66</div>
              <div class="phone-number">
                <input type="tel" id="phone" name="phone" placeholder="812345678" maxlength="20" required>
              </div>
            </div>
            <div class="help-text">Enter phone number without country code</div>
            <div class="error-message" id="errPhone"></div>
            <div class="success-message" id="successPhone"></div>
          </div>

          <div class="form-group">
            <label for="country">Country <span class="required">*</span></label>
            <div class="input-wrapper">
              <select id="country" name="country" required>
                <option value="">Select your country</option>
                <optgroup label="🌏 Asia-Pacific">
                  <option value="TH">🇹🇭 Thailand</option>
                  <option value="SG">🇸🇬 Singapore</option>
                  <option value="MY">🇲🇾 Malaysia</option>
                  <option value="ID">🇮🇩 Indonesia</option>
                  <option value="VN">🇻🇳 Vietnam</option>
                  <option value="PH">🇵🇭 Philippines</option>
                  <option value="JP">🇯🇵 Japan</option>
                  <option value="KR">🇰🇷 South Korea</option>
                  <option value="IN">🇮🇳 India</option>
                  <option value="AU">🇦🇺 Australia</option>
                  <option value="NZ">🇳🇿 New Zealand</option>
                </optgroup>
                <optgroup label="🌎 Americas">
                  <option value="US">🇺🇸 United States</option>
                  <option value="CA">🇨🇦 Canada</option>
                  <option value="MX">🇲🇽 Mexico</option>
                  <option value="BR">🇧🇷 Brazil</option>
                  <option value="AR">🇦🇷 Argentina</option>
                </optgroup>
                <optgroup label="🌍 Europe">
                  <option value="GB">🇬🇧 United Kingdom</option>
                  <option value="FR">🇫🇷 France</option>
                  <option value="DE">🇩🇪 Germany</option>
                  <option value="IT">🇮🇹 Italy</option>
                  <option value="ES">🇪🇸 Spain</option>
                  <option value="NL">🇳🇱 Netherlands</option>
                  <option value="SE">🇸🇪 Sweden</option>
                  <option value="NO">🇳🇴 Norway</option>
                  <option value="DK">🇩🇰 Denmark</option>
                  <option value="FI">🇫🇮 Finland</option>
                  <option value="PL">🇵🇱 Poland</option>
                  <option value="GR">🇬🇷 Greece</option>
                  <option value="TR">🇹🇷 Turkey</option>
                  <option value="RU">🇷🇺 Russia</option>
                  <option value="UA">🇺🇦 Ukraine</option>
                </optgroup>
                <optgroup label="🌍 Middle East & Africa">
                  <option value="AE">🇦🇪 UAE</option>
                  <option value="SA">🇸🇦 Saudi Arabia</option>
                  <option value="QA">🇶🇦 Qatar</option>
                  <option value="KW">🇰🇼 Kuwait</option>
                  <option value="BH">🇧🇭 Bahrain</option>
                  <option value="OM">🇴🇲 Oman</option>
                  <option value="IL">🇮🇱 Israel</option>
                  <option value="EG">🇪🇬 Egypt</option>
                  <option value="ZA">🇿🇦 South Africa</option>
                  <option value="NG">🇳🇬 Nigeria</option>
                  <option value="KE">🇰🇪 Kenya</option>
                  <option value="GH">🇬🇭 Ghana</option>
                  <option value="MA">🇲🇦 Morocco</option>
                </optgroup>
              </select>
            </div>
            <div class="error-message" id="errCountry"></div>
          </div>

          <div class="form-group">
            <label for="nationalId">National ID / Passport <span class="required">*</span></label>
            <div class="input-wrapper">
              <input type="text" id="nationalId" name="nationalId" placeholder="1234567890123" maxlength="20" required>
            </div>
            <div class="help-text" id="idHelp">Enter your 13-digit Thai ID card number</div>
            <div class="error-message" id="errNationalId"></div>
            <div class="success-message" id="successNationalId"></div>
          </div>
        </div>

        <!-- Step 3: Security -->
        <div class="step-section" data-step="3">
          <h2 style="margin-bottom: 20px; color: var(--primary);">Secure Your Account</h2>

          <div class="form-group">
            <label for="password">Password <span class="required">*</span></label>
            <div class="input-wrapper">
              <input type="password" id="password" name="password" placeholder="Enter a strong password" minlength="8" required>
            </div>
            <div class="password-strength">
              <div class="strength-bar">
                <div class="strength-fill" id="strengthFill"></div>
              </div>
              <div class="strength-text" id="strengthText">Enter at least 8 characters</div>
            </div>
            <div class="error-message" id="errPassword"></div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
            <div class="input-wrapper">
              <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password" required>
            </div>
            <div class="error-message" id="errConfirmPassword"></div>
            <div class="success-message" id="successConfirmPassword"></div>
          </div>

          <div class="form-group">
            <label for="wallet">Wallet Address (Optional)</label>
            <div class="input-wrapper">
              <input type="text" id="wallet" name="wallet" placeholder="0x..." maxlength="42">
            </div>
            <div class="help-text">Ethereum or Polygon wallet for future NFT claims</div>
            <div class="error-message" id="errWallet"></div>
            <div class="success-message" id="successWallet"></div>
          </div>
        </div>

        <!-- Step 4: AI Rights -->
        <div class="step-section" data-step="4">
          <h2 style="margin-bottom: 20px; color: var(--primary);">AI Rights & Preferences</h2>

          <div class="checkbox-group">
            <input type="checkbox" id="claimTokens" name="claimTokens" checked>
            <label for="claimTokens">
              <strong>🪙 Reserve My AI Rights Tokens</strong><br>
              Claim your AIVID (Identity), AIPLT (Patent Rights), and SLIVR (Search Visibility) tokens
            </label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="marketing" name="marketing">
            <label for="marketing">
              <strong>📧 Stay Updated</strong><br>
              Receive updates about AI Rights ecosystem and new features
            </label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="terms" name="terms" required>
            <label for="terms">
              I agree to the <a href="/terms" target="_blank">Terms of Service</a> and 
              <a href="/privacy" target="_blank">Privacy Policy</a> <span class="required">*</span>
            </label>
          </div>
          <div class="error-message" id="errTerms">You must agree to the terms to continue</div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary hidden" id="prevBtn" onclick="changeStep(-1)">
            Previous
          </button>
          <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)" style="display: none;">
            Next Step
          </button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="loading-spinner" id="loadingSpinner"></span>
            <span>🚀 Create My AIVerID™</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>© 2025 AIVerID™. All Rights Reserved.</p>
      <p>
        <a href="/terms">Terms</a>
        <a href="/privacy">Privacy</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
      </p>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const API_CONFIG = {
      API_URL: 'https://aiverid-backend-production.up.railway.app/api/auth/register',
      API_HEALTH: 'https://aiverid-backend-production.up.railway.app/api/health',
      API_TIMEOUT: 10000,
      MAX_RETRIES: 3,
      RETRY_DELAY: 1000,
      AUTO_SAVE_DELAY: 3000
    };

    // Country codes mapping
    const countryCodes = {
      'TH': '+66', 'SG': '+65', 'MY': '+60', 'ID': '+62', 'VN': '+84', 'PH': '+63', 'JP': '+81', 'KR': '+82', 'IN': '+91', 'AU': '+61', 'NZ': '+64',
      'US': '+1', 'CA': '+1', 'MX': '+52', 'BR': '+55', 'AR': '+54',
      'GB': '+44', 'FR': '+33', 'DE': '+49', 'IT': '+39', 'ES': '+34', 'NL': '+31', 'SE': '+46', 'NO': '+47', 'DK': '+45', 'FI': '+358', 'PL': '+48', 
      'GR': '+30', 'TR': '+90', 'RU': '+7', 'UA': '+380',
      'AE': '+971', 'SA': '+966', 'QA': '+974', 'KW': '+965', 'BH': '+973', 'OM': '+968', 'IL': '+972', 'EG': '+20', 'ZA': '+27', 'NG': '+234', 'KE': '+254', 'GH': '+233', 'MA': '+212'
    };

    const idPatterns = { 
      'TH':{pattern:/^\d{1}-?\d{4}-?\d{5}-?\d{2}-?\d{1}$/,help:'Thai ID: 13 digits (1-2345-67890-12-3)'},
      'US':{pattern:/^\d{3}-?\d{2}-?\d{4}$/,help:'US SSN: 9 digits (123-45-6789)'},
      'SG':{pattern:/^[STFG]\d{7}[A-Z]$/,help:'Singapore NRIC: S1234567A format'},
      'MY':{pattern:/^\d{6}-?\d{2}-?\d{4}$/,help:'Malaysia IC: 12 digits (123456-78-9012)'},
      'ID':{pattern:/^\d{16}$/,help:'Indonesia KTP: 16 digits'},
      'JP':{pattern:/^\d{12}$/,help:'Japan My Number: 12 digits'},
      'KR':{pattern:/^\d{6}-?\d{7}$/,help:'South Korea: 13 digits (123456-1234567)'},
      'IN':{pattern:/^\d{4}\s?\d{4}\s?\d{4}$/,help:'India Aadhaar: 12 digits (1234 5678 9012)'},
      'AU':{pattern:/^\d{8,9}$/,help:'Australia TFN: 8-9 digits'},
      'GB':{pattern:/^[A-Z]{2}\d{6}[A-D]$/,help:'UK National Insurance: AA123456A'},
      'DE':{pattern:/^\d{11}$/,help:'Germany Tax ID: 11 digits'},
      'CA':{pattern:/^\d{3}-?\d{3}-?\d{3}$/,help:'Canada SIN: 9 digits (123-456-789)'} 
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let currentMode = 'simple';
    let currentStep = 1;
    let autoSaveTimeout;
    let apiHealthy = false;

    // ============================================
    // PAGE INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 AIVerID Registration System - Production Version');
      checkAPIHealth();
      initializePage();
      setupEventListeners();
      setDefaultValues();
      loadSavedFormData();
      setInterval(checkAPIHealth, 30000);
    });

    function initializePage() {
      setMode('simple');
      document.getElementById('firstName').focus();
      document.getElementById('country').value = 'TH';
      updateCountryCode('TH');
      updateIdValidation('TH');
    }

    function setupEventListeners() {
      document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
      document.querySelectorAll('.type-card').forEach(card => card.addEventListener('click', () => selectAccountType(card.dataset.type)));
      document.getElementById('country').addEventListener('change', function() {
        updateCountryCode(this.value);
        updateIdValidation(this.value);
        validateField('nationalId');
        updateSectionIndicators();
      });
      
      const inputs = ['firstName', 'lastName', 'email', 'phone', 'nationalId', 'password', 'confirmPassword', 'wallet'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
          el.addEventListener('input', () => {
            if (id !== 'password') validateField(id);
            updateSectionIndicators();
            scheduleAutoSave();
          });
          el.addEventListener('blur', () => validateField(id));
        }
      });

      document.getElementById('password').addEventListener('input', function() {
        updatePasswordStrength(this.value);
        validateField('password');
      });
      
      document.getElementById('registerForm').addEventListener('submit', handleFormSubmit);
    }

    function setDefaultValues() {
      document.getElementById('country').value = 'TH';
      updateCountryCode('TH');
      document.getElementById('claimTokens').checked = true;
    }

    // ============================================
    // UI & MODE MANAGEMENT
    // ============================================
    function setMode(mode) {
      currentMode = mode;
      const container = document.querySelector('.register-container');
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
      
      const isSteps = mode === 'steps';
      container.classList.toggle('step-mode', isSteps);
      container.classList.toggle('section-simple', !isSteps);
      document.getElementById('progressSteps').classList.toggle('hidden', !isSteps);
      document.getElementById('sectionIndicator').classList.toggle('show', !isSteps);
      document.querySelectorAll('.step-mode-only').forEach(el => el.classList.toggle('hidden', !isSteps));
      document.querySelectorAll('.simple-mode-only').forEach(el => el.classList.toggle('hidden', isSteps));
      
      if (isSteps) {
        updateStepDisplay();
      } else {
        document.querySelectorAll('.step-section').forEach(section => section.classList.add('active'));
        updateSectionIndicators();
      }
    }

    function selectAccountType(type) {
      document.querySelectorAll('.type-card').forEach(card => card.classList.remove('selected'));
      document.querySelector(`[data-type="${type}"]`).classList.add('selected');
      document.getElementById('accountType').value = type;
      
      const orgFields = document.getElementById('orgFields');
      if (type === 'organization') {
          orgFields.classList.add('show');
      } else {
          orgFields.classList.remove('show');
      }
      
      clearFieldError('accountType');
      updateSectionIndicators();
      scheduleAutoSave();
    }

    function updateCountryCode(countryCode) {
      document.getElementById('countryCode').textContent = countryCodes[countryCode] || '+??';
    }

    function updateIdValidation(countryCode) {
      const idField = document.getElementById('nationalId');
      const helpText = document.getElementById('idHelp');
      
      if (idPatterns[countryCode]) {
        helpText.textContent = idPatterns[countryCode].help;
      } else {
        helpText.textContent = 'Enter your national ID or passport number';
      }
    }

    // ============================================
    // STEP NAVIGATION
    // ============================================
    function changeStep(direction) {
      if (currentMode !== 'steps') return;
      
      if (direction > 0 && !validateCurrentStep()) return;
      
      const newStep = currentStep + direction;
      if (newStep < 1 || newStep > 4) return;
      
      currentStep = newStep;
      updateStepDisplay();
    }

    function updateStepDisplay() {
      document.querySelectorAll('.step-section').forEach(section => {
        section.classList.toggle('active', parseInt(section.dataset.step) === currentStep);
      });
      
      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.toggle('active', stepNum === currentStep);
        step.classList.toggle('completed', stepNum < currentStep);
      });
      
      document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
      document.getElementById('nextBtn').style.display = currentStep < 4 ? 'block' : 'none';
      document.getElementById('submitBtn').style.display = currentStep === 4 ? 'block' : 'none';
    }

    function validateCurrentStep() {
      let valid = true;
      
      switch(currentStep) {
        case 1:
          if (!document.getElementById('accountType').value) {
            showFieldError('accountType', 'Please select an account type');
            valid = false;
          }
          if (document.getElementById('accountType').value === 'organization') {
            if (!validateField('companyName')) valid = false;
            if (!validateField('adminName')) valid = false;
          }
          break;
        case 2:
          if (!validateField('firstName')) valid = false;
          if (!validateField('lastName')) valid = false;
          if (!validateField('email')) valid = false;
          if (!validateField('phone')) valid = false;
          if (!validateField('country')) valid = false;
          if (!validateField('nationalId')) valid = false;
          break;
        case 3:
          if (!validateField('password')) valid = false;
          if (!validateField('confirmPassword')) valid = false;
          if (document.getElementById('wallet').value && !validateField('wallet')) valid = false;
          break;
      }
      
      return valid;
    }

    // ============================================
    // FORM VALIDATION
    // ============================================
    function validateField(fieldId) {
      const field = document.getElementById(fieldId);
      if (!field) return true;
      
      const value = field.value.trim();
      let valid = true;
      let errorMessage = '';
      
      clearFieldError(fieldId);
      clearFieldSuccess(fieldId);
      
      switch(fieldId) {
        case 'accountType':
          if (!value) {
            errorMessage = 'Please select an account type';
            valid = false;
          }
          break;
          
        case 'firstName':
        case 'lastName':
          if (!value) {
            errorMessage = `${fieldId === 'firstName' ? 'First' : 'Last'} name is required`;
            valid = false;
          } else if (value.length < 1 || value.length > 50) {
            errorMessage = 'Name must be 1-50 characters';
            valid = false;
          }
          break;
          
        case 'companyName':
          if (document.getElementById('accountType').value === 'organization' && !value) {
            errorMessage = 'Company name is required for organizations';
            valid = false;
          }
          break;
          
        case 'adminName':
          if (document.getElementById('accountType').value === 'organization' && !value) {
            errorMessage = 'Admin name is required for organizations';
            valid = false;
          }
          break;
          
        case 'email':
          const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
          if (!value) {
            errorMessage = 'Email is required';
            valid = false;
          } else if (!emailRegex.test(value)) {
            errorMessage = 'Please enter a valid email address';
            valid = false;
          }
          break;
          
        case 'phone':
          const phoneRegex = /^[0-9]{8,15}$/;
          if (!value) {
            errorMessage = 'Phone number is required';
            valid = false;
          } else if (!phoneRegex.test(value.replace(/[- ]/g, ''))) {
            errorMessage = 'Please enter a valid phone number (8-15 digits)';
            valid = false;
          }
          break;
          
        case 'country':
          if (!value) {
            errorMessage = 'Please select your country';
            valid = false;
          }
          break;
          
        case 'nationalId':
          if (!value) {
            errorMessage = 'National ID or passport is required';
            valid = false;
          } else {
            const countryCode = document.getElementById('country').value;
            if (idPatterns[countryCode] && !idPatterns[countryCode].pattern.test(value)) {
              errorMessage = idPatterns[countryCode].help;
              valid = false;
            }
          }
          break;
          
        case 'password':
          if (!value) {
            errorMessage = 'Password is required';
            valid = false;
          } else if (value.length < 8) {
            errorMessage = 'Password must be at least 8 characters';
            valid = false;
          }
          break;
          
        case 'confirmPassword':
          const password = document.getElementById('password').value;
          if (!value) {
            errorMessage = 'Please confirm your password';
            valid = false;
          } else if (value !== password) {
            errorMessage = 'Passwords do not match';
            valid = false;
          }
          break;
          
        case 'wallet':
          if (value && !/^0x[a-fA-F0-9]{40}$/.test(value)) {
            errorMessage = 'Please enter a valid Ethereum wallet address';
            valid = false;
          }
          break;
      }
      
      if (!valid) {
        showFieldError(fieldId, errorMessage);
      } else if (value) {
        showFieldSuccess(fieldId);
      }
      
      return valid;
    }

    function validateAllFields() {
      const requiredFields = ['accountType', 'firstName', 'lastName', 'email', 'phone', 'country', 'nationalId', 'password', 'confirmPassword'];
      
      if (document.getElementById('accountType').value === 'organization') {
        requiredFields.push('companyName', 'adminName');
      }
      
      let allValid = true;
      requiredFields.forEach(field => {
        if (!validateField(field)) {
          allValid = false;
        }
      });
      
      if (!document.getElementById('terms').checked) {
        showFieldError('terms', 'You must agree to the terms to continue');
        allValid = false;
      }
      
      return allValid;
    }

    // ============================================
    // PASSWORD STRENGTH
    // ============================================
    function updatePasswordStrength(password) {
      const strengthFill = document.getElementById('strengthFill');
      const strengthText = document.getElementById('strengthText');
      
      const score = calculatePasswordStrength(password);
      
      const colors = ['#ef4444', '#f59e0b', '#eab308', '#22c55e', '#10b981'];
      const widths = ['20%', '40%', '60%', '80%', '100%'];
      const texts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
      
      strengthFill.style.width = widths[score];
      strengthFill.style.background = colors[score];
      strengthText.textContent = texts[score];
    }

    function calculatePasswordStrength(password) {
      let score = 0;
      if (password.length >= 8) score++;
      if (password.length >= 12) score++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
      if (/\d/.test(password)) score++;
      if (/[@$!%*?&]/.test(password)) score++;
      return Math.min(score, 4);
    }

    // ============================================
    // DOM & ERROR/SUCCESS DISPLAY
    // ============================================
    function showFieldError(id, message) {
      const el = document.getElementById(`err${id.charAt(0).toUpperCase() + id.slice(1)}`);
      const field = document.getElementById(id);
      if(el) { el.textContent = message; el.classList.add('show'); }
      if(field) field.classList.add('error');
    }

    function clearFieldError(id) {
      const el = document.getElementById(`err${id.charAt(0).toUpperCase() + id.slice(1)}`);
      const field = document.getElementById(id);
      if(el) el.classList.remove('show');
      if(field) field.classList.remove('error');
    }

    function showFieldSuccess(id) {
      const el = document.getElementById(`success${id.charAt(0).toUpperCase() + id.slice(1)}`);
      const field = document.getElementById(id);
      if(el) { el.textContent = '✓'; el.classList.add('show'); }
      if(field) field.classList.add('success');
    }

    function clearFieldSuccess(id) {
      const el = document.getElementById(`success${id.charAt(0).toUpperCase() + id.slice(1)}`);
      if(el) el.classList.remove('show');
    }

    // ============================================
    // FORM SUBMISSION & DATA HANDLING
    // ============================================
    function scheduleAutoSave() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(autoSave, API_CONFIG.AUTO_SAVE_DELAY);
    }

    function autoSave() {
      const data = Object.fromEntries(new FormData(document.getElementById('registerForm')).entries());
      try {
        sessionStorage.setItem('aiverIdFormData', JSON.stringify(data));
        const indicator = document.getElementById('autoSave');
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
      } catch (e) { console.error('Auto-save failed:', e); }
    }

    function loadSavedFormData() {
      try {
        const savedData = JSON.parse(sessionStorage.getItem('aiverIdFormData'));
        if (savedData) {
          Object.keys(savedData).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
              if (el.type === 'checkbox') el.checked = savedData[key] === 'true' || savedData[key] === true;
              else el.value = savedData[key];
            }
          });
          if (savedData.accountType) selectAccountType(savedData.accountType);
          if (savedData.country) { updateCountryCode(savedData.country); updateIdValidation(savedData.country); }
          if (savedData.password) updatePasswordStrength(savedData.password);
          updateSectionIndicators();
        }
      } catch (e) { console.error('Could not load form data:', e); }
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      if (!validateAllFields()) {
        document.querySelector('.error, .error-message.show')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      
      const btn = e.submitter, spinner = btn.querySelector('.loading-spinner'), text = btn.querySelector('span');
      btn.disabled = true;
      spinner.classList.add('show');
      text.textContent = 'Creating Account...';
      
      try {
        const formData = {
          accountType: document.getElementById('accountType').value,
          firstName: document.getElementById('firstName').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('countryCode').textContent + document.getElementById('phone').value.trim(), // Fixed: phone instead of phoneNumber
          country: document.getElementById('country').value,
          password: document.getElementById('password').value,
          idcard: document.getElementById('nationalId').value.trim(), // Fixed: idcard instead of aiverIdNumber
          wallet: document.getElementById('wallet').value.trim(),
          claimTokens: document.getElementById('claimTokens').checked,
          marketing: document.getElementById('marketing').checked,
          companyName: document.getElementById('companyName')?.value?.trim() || '',
          adminName: document.getElementById('adminName')?.value?.trim() || '',
          registrationNumber: document.getElementById('registrationNumber')?.value?.trim() || ''
        };
        
        console.log('📤 Submitting:', { ...formData, password: '***' });
        const result = await submitRegistrationWithRetry(formData);
        
        if (result.success) {
          showSuccessModal(result.data);
          sessionStorage.removeItem('aiverIdFormData');
        } else {
          throw new Error(result.error || 'Registration failed');
        }
      } catch (error) {
        console.error('❌ Registration error:', error);
        handleRegistrationError(error);
      } finally {
        btn.disabled = false;
        spinner.classList.remove('show');
        text.textContent = '🚀 Create My AIVerID™';
      }
    }

    // ============================================
    // API INTERACTION
    // ============================================
    async function checkAPIHealth() {
      const statusEl = document.getElementById('apiStatus'), textEl = document.getElementById('apiStatusText');
      try {
        statusEl.className = 'api-status checking';
        textEl.textContent = 'Checking API...';
        const res = await fetch(API_CONFIG.API_HEALTH, { signal: AbortSignal.timeout(5000) });
        if (!res.ok) throw new Error('API not responding');
        apiHealthy = true;
        statusEl.className = 'api-status connected';
        textEl.textContent = '✅ API Connected';
        setTimeout(() => { statusEl.style.opacity = '0.5'; }, 3000);
      } catch (e) {
        apiHealthy = false;
        statusEl.className = 'api-status disconnected';
        textEl.textContent = '❌ API Offline - Demo Mode';
        statusEl.style.opacity = '1';
      }
    }

    async function submitRegistrationWithRetry(formData, retries = 0) {
      try {
        const res = await fetch(API_CONFIG.API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(formData),
          signal: AbortSignal.timeout(API_CONFIG.API_TIMEOUT)
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        console.log('✅ Registration successful:', data);
        return { success: true, data: { ...data.user, email: formData.email, accountType: formData.accountType, claimTokens: formData.claimTokens } };
        
      } catch (error) {
        console.error(`Attempt ${retries + 1} failed:`, error);
        if ((error.name === 'AbortError' || error.message.includes('500')) && retries < API_CONFIG.MAX_RETRIES) {
          await new Promise(r => setTimeout(r, API_CONFIG.RETRY_DELAY));
          return submitRegistrationWithRetry(formData, retries + 1);
        }
        if (!apiHealthy || error.name === 'TypeError') return submitRegistrationDemo(formData);
        throw error;
      }
    }

    async function submitRegistrationDemo(formData) {
      console.log('📌 Demo mode submission');
      await new Promise(r => setTimeout(r, 1500));
      if (formData.email === 'exists@test.com') throw new Error('email_exists');
      return { success: true, data: { id: `AID-DEMO-${Date.now()}`, ...formData } };
    }

    // ============================================
    // MODALS AND ERROR HANDLING
    // ============================================
    function handleRegistrationError(error) {
        let message = 'An unknown error occurred. Please try again.';
        if (error.message.includes('email_exists')) {
            showFieldError('email', 'This email is already registered.');
            return;
        }
        if (error.message.includes('validation_error')) message = 'Please check all fields and try again.';
        if (error.message.includes('server_error')) message = 'Server error. Please try again later.';
        if (error.name === 'AbortError') message = 'Request timed out. Please check your connection.';
        showGlobalError(message);
    }

    function showSuccessModal(data) {
      const modal = document.createElement('div');
      modal.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: fadeIn 0.3s ease; backdrop-filter: blur(10px);`;
      
      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1e293b, #334155); border: 1px solid rgba(0,212,255,0.3); color: #e2e8f0; padding: 2.5rem; border-radius: 20px; max-width: 450px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5), 0 0 25px rgba(0,212,255,0.2);">
          <div style="font-size: 4rem; margin-bottom: 1.5rem;">🎉</div>
          <h2 style="color: #00d4ff; margin-bottom: 1rem; font-size: 1.5rem; font-weight: 800;">Registration Successful!</h2>
          <p style="margin-bottom: 1.5rem; color: #cbd5e1; line-height: 1.6;">
            Your AIVerID™ has been created successfully!<br>
            <strong style="color: #00d4ff;">AIVerID:</strong> ${data.id || 'N/A'}<br>
            <strong style="color: #00d4ff;">Email:</strong> ${data.email}<br>
          </p>
          ${data.claimTokens ? `<p style="margin-bottom: 1.5rem; color: #60a5fa; font-size: 0.9rem; background: rgba(0,212,255,0.1); padding: 1rem; border-radius: 10px; border: 1px solid rgba(0,212,255,0.2);">🪙 Your AI Rights tokens have been reserved!</p>` : ''}
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 0.9rem; color: #cbd5e1; border: 1px solid rgba(255,255,255,0.1);">
            <strong>📧 Next Steps:</strong><br>
            1. Check your email for verification<br>
            2. Login to access your dashboard<br>
            3. Complete your profile
          </div>
          <button onclick="window.location.href='/login?email=${encodeURIComponent(data.email)}&registered=true'" style="background: linear-gradient(135deg, #00d4ff, #6366f1); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; font-size: 1rem; box-shadow: 0 4px 20px rgba(0,212,255,0.3); transition: all 0.3s ease;">
            🔐 Login to Your Account
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function showGlobalError(message) {
      const alert = document.getElementById('globalAlert');
      alert.textContent = message;
      alert.className = 'global-alert error show';
      setTimeout(() => alert.classList.remove('show'), 5000);
    }

    function updateSectionIndicators() {
      if (currentMode !== 'simple') return;
      
      const dots = document.querySelectorAll('.section-dot');
      const sections = {
        type: !!document.getElementById('accountType').value,
        info: ['firstName', 'lastName', 'email', 'phone', 'nationalId'].every(id => document.getElementById(id).value),
        security: document.getElementById('password').value && document.getElementById('confirmPassword').value,
        rights: document.getElementById('terms').checked
      };
      
      Object.keys(sections).forEach(section => {
        const dot = document.querySelector(`.section-dot[data-section="${section}"]`);
        if (dot) {
          dot.classList.toggle('completed', sections[section]);
        }
      });
    }

    // ============================================
    // ANIMATIONS & CSS INJECTION
    // ============================================
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
